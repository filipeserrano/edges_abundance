---
title: "Edges, abundances and sun"
author: "Filipey and Piew"
date: "2025-06-17"
output:
  html_document:
    theme: darkly
    highlight: haddock
    toc: true
    toc_depth: 4
    number_sections: false
    toc_float: true
    css: css_perso.css
  pdf_document:
    toc: true
    toc_depth: '4'
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(dplyr)
library(tidyr)
library(magrittr)
library(tidyverse)
library(knitr)
library(ggdist) # only if rainplot
library(ggplot2)
library(glmmTMB)
library(DHARMa)
library(MuMIn)
library(performance)
library(emmeans)
library(sjPlot)
library(ggeffects)

```

# Plan of action

## Idea on what we could do

-   **Basic visualisation**

    -   simple representation of the variables relation
    -   sample size and distribution of the predictor

    <br>

-   **Univariate model selection**

    -   $y_d$ (decreasing) - `[0, 1]`
    -   $y_i$ (increasing) - `[0, 1]`

<br>

-   **Multivariate model**
    -   Fixed and random structured selected during univariate model
        selection
    -   Test for bivariate model $(y_d, y_i)$ using `brms`
    -   Test for trivariate model with the constant dynamic $y_c$ :
        $(y_d, y_c, y_i)$

<br> <br>

## Some considerations

The better would be to go *crescendo* in term of complexity and maybe
focus on the modelisation of the demographic dynamics **at the taxa
levels** for a first try, and then analyse the specific-slopes. With
that in mind, we have to think on the way we'll sort the dataframe. At
the **population level**, could be useful to keep all the statistical
power we have, but at the deeper (specific) level, maybe filter by
species' population sample size.

<br> <br>

# Data importation

`data` have been pre-treated within the script

<script>

.

<!-- setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) -->

```{r include=F}
# Demographic trends populations dataset

trends_populations = read.csv("trends_populations.csv", row.names = NULL) %>%
  dplyr::filter(Group != "Reptiles") %>% #Reptiles had a much lower number of populations thus were excluded
  dplyr::mutate(
    lat_abs = abs(Latitude),
    lat_abs_scaled = scale(lat_abs),
    reldist_trailing_scaled = scale(reldist_trailing),
    reldist_leading_scaled = scale(reldist_leading)
  )

mean_used <- attr(trends_populations$lat_abs_scaled, "scaled:center")
sd_used <- attr(trends_populations$lat_abs_scaled, "scaled:scale")

```

<br> <br>

```{r echo=FALSE}

cols1 = c("Amphibians" = "turquoise4",
          "Mammals" = "chocolate4",
          "Birds" = "goldenrod1")
trends_hist_group = trends_populations %>% 
  ggplot(., aes(x = reldist_trailing, fill = Group)) + geom_density(aes(alpha = 0.5))+ 
  scale_fill_manual(values = cols1) + theme_classic(base_size = 18)+
  labs(x = "Relative distance to trailing edge",
       y = "Density of records") + scale_alpha(guide = 'none')

print(trends_hist_group)
ggsave(plot = last_plot(),"trends_hist_group.jpg")

```

Populations are mostly sampled far away from the edges, although
amphibians tend to be sampled further away from the trailing edge (thus
closer to the leading edge)

```{r}
# Crossing equator populations are removed
df_decrease <- trends_populations %>% 
  dplyr::filter(cross_equator == 0)
```

<br> <br>

# Data visualisation

## Variables distributions

```{r}

```

<br>

## Variables sample size per group

```{r}

```

<br> <br>

# Univariate modeling

This part aims to

## Decreasing $y_d$

```{r}

## running the global model of decrease at the trailing edge
global_model_decrease <- glmmTMB(formula = decreasing ~ -1 + reldist_trailing_scaled + 
                                   (reldist_trailing_scaled * Group) +                        
                                   (reldist_trailing_scaled * lat_abs_scaled) +
                                   (lat_abs_scaled * Group) +
                                   (reldist_trailing_scaled|Species:Group) +
                                   (1|last_year),
                                 family = binomial,
                                 data = df_decrease,
                                 na.action = "na.fail")


summary(global_model_decrease)

# dredge model selection
dredge_selection_decrease <- dredge(global.model = global_model_decrease)
dredge_selection_decrease

# the best model (lowest AIC and lower df) includes relative distance to trailing edge and group, without interaction
decrease6 <- glmmTMB(formula = decreasing ~ -1 + reldist_trailing_scaled + Group  + 
                        (reldist_trailing_scaled|Species:Group) +
                        (1|last_year),
                      family = binomial,
                      data = df_decrease,
                      na.action = "na.fail")

summary(decrease6) 

# testing collinearity
performance::check_collinearity(
  decrease6,
  component = c('all') # 'all' shows both conditional and zi components
)


(emm_lm_c_threat_decrease = emmeans::emmeans(decrease6, specs = pairwise ~ Group , type = "response", adjust = "none"))[2]

performance(decrease6) # very low R2

mod_data_decrease = get_model_data(decrease6, terms = c("reldist_trailing_scaled", "Group"), type = "pred") %>% 
  as.data.frame()
```

```{r}
# plotting the predicted values for the best model
plot_decrease6 = plot(ggeffects::ggpredict(decrease6, terms = c("reldist_trailing_scaled", "Group"), typical = "weighted_mean", interval = "confidence"))+
  scale_fill_manual(values = cols1) +
  scale_color_manual(values = cols1) + theme_classic() +
  xlab("Relative distance to trailing edge") +
  ylab("Probability of decreasing") 

print(plot_decrease6)
ggsave(plot = last_plot(),"predicted_decreasing_trailing.jpg")


# plotting the predicted values for the random effect (last year of sampling)
plot_decrease6_year = plot(ggeffects::ggpredict(decrease6, terms = c("last_year"), type = "random")) + 
  theme_classic() +
  xlab("Final year of sampling") +
  ylab("Probability of decreasing") 

print(plot_decrease6_year)
ggsave(plot = last_plot(),"lastyear_decreasing_trailing.jpg")

# getting the slope of relative distance to trailing edge on the log-odds of probability of decreasing
fixed_slope_decrease <- fixef(decrease6)$cond["reldist_trailing_scaled"]


# by selecting only the random effect of species (nested within group), converting values from the log-odds to probability 
ranef_mod_decrease= ranef(decrease6) %>% 
  as.data.frame() %>% 
  dplyr::filter(grpvar != "last_year") %>% 
  tidyr::separate(grp, c("Species", "Group"),sep=":",remove=F) %>% 
  dplyr::mutate(prob_intercept_decrease = ifelse(term=="(Intercept)", plogis(.$condval), "NA" ), # estimated probability that specific species is decreasing at that average distance to the edge (since we scaled relative distance to trailing edge)
                logit_lower_decrease = ifelse(term=="(Intercept)", plogis(condval - 1.96 * condsd), "NA"), # lower bound of confidence interval
                logit_upper_decrease = ifelse(term=="(Intercept)",plogis(condval + 1.96 * condsd), "NA"),  # upper bound of confidence interval
                group_slopes_decrease = ifelse(term=="reldist_trailing_scaled", .$condval + fixed_slope_decrease, "NA")) # species-specific slope


plot_species_slope_decrease = ggplot(ranef_mod_decrease, aes(x = as.factor(Group), y = as.numeric(group_slopes_decrease), fill = factor(Group))) + 
  stat_halfeye(adjust = 0.6,
               justification = -.1,
               .width = 0.01,
               point_colour = NA) +
  geom_boxplot(alpha = 0.6,
               width = .1) +
  scale_fill_manual(values = cols1) + theme_classic(base_size = 17) + geom_hline(yintercept = 0, color = "black", size = .7, linetype = 2) +
  ylab("Slope of probability of decreasing x Distance to trailing edge") + 
  xlab("") +  theme(legend.position="none",
                    axis.text.x=element_text(size=15)) +
  coord_flip()

print(plot_species_slope_decrease)
ggsave(plot = last_plot(),"slope_speciesgroup_decreasing_trailing.jpg")


```


``` {r}

```
<br> 
<br>

## Increasing $y_i$

```{r}
## running the global model of decrease at the trailing edge
global_model_increase <- glmmTMB(formula = increasing ~ -1 + reldist_leading_scaled + 
                                   (reldist_leading_scaled * Group) +                        
                                   (reldist_leading_scaled * lat_abs_scaled) +
                                   (lat_abs_scaled * Group) +
                                   (reldist_leading_scaled|Species:Group) +
                                   (1|last_year),
                                 family = binomial,
                                 data = trends_populations,
                                 na.action = "na.fail")


summary(global_model_increase)

# dredge model selection
dredge_selection_increase <- dredge(global.model = global_model_increase)
dredge_selection_increase

# the best model (lowest AIC and lower df) includes relative distance to trailing edge and group, without interaction
increase_model <- glmmTMB(formula = increasing ~ -1 + reldist_leading_scaled + Group  + lat_abs_scaled +
                        (reldist_leading_scaled|Species:Group) +
                        (1|last_year),
                      family = binomial,
                      data = trends_populations,
                      na.action = "na.fail")

summary(increase_model)

# testing collinearity
performance::check_collinearity(
  increase_model,
  component = c('all') # 'all' shows both conditional and zi components
)


(emm_increase = emmeans::emmeans(increase_model, specs = pairwise ~ Group , type = "response", adjust = "none"))[2]

performance(increase_model) # low R2

mod_data_increase = get_model_data(increase_model, terms = c("reldist_leading_scaled", "Group"), type = "pred") %>% 
  as.data.frame()

```

<br>
<br>

```{r}
# plotting the predicted values for the best model
names(dose.labs) <- c("28", "1", "2")

plot_increase = plot(ggeffects::ggpredict(increase_model, terms = c("reldist_leading_scaled", "Group", "lat_abs_scaled"), typical = "weighted_mean", interval = "confidence"))+
  scale_fill_manual(values = cols1) +
  scale_color_manual(values = cols1) + theme_classic() +
  xlab("Relative distance to leading edge") +
  ylab("Probability of increasing")  

print(plot_increase)
ggsave(plot = last_plot(),"predicted_increasing_leading.jpg")

# lat_abs_scaled = -1 -> 28.47651
# lat_abs_scaled = 0 -> 41.16485
# lat_abs_scaled = 1 -> 53.85319

# plotting the predicted values for the random effect (last year of sampling)
plot_increase_year = plot(ggeffects::ggpredict(increase_model, terms = c("last_year"), type = "random")) + 
  theme_classic() +
  xlab("Final year of sampling") +
  ylab("Probability of increasing") 

print(plot_increase_year)
ggsave(plot = last_plot(),"lastyear_increasing_leading.jpg")

# getting the slope of relative distance to trailing edge on the log-odds of probability of increasing
fixed_slope_increase <- fixef(increase_model)$cond["reldist_leading_scaled"]


# by selecting only the random effect of species (nested within group), converting values from the log-odds to probability 
ranef_mod_increase= ranef(increase_model) %>% 
  as.data.frame() %>% 
  dplyr::filter(grpvar != "last_year") %>% 
  tidyr::separate(grp, c("Species", "Group"),sep=":",remove=F) %>% 
  dplyr::mutate(prob_intercept_increase = ifelse(term=="(Intercept)", plogis(.$condval), "NA" ), # estimated probability that specific species is increasing at that average distance to the edge (since we scaled relative distance to leading edge)
                logit_lower_increase = ifelse(term=="(Intercept)", plogis(condval - 1.96 * condsd), "NA"), # lower bound of confidence interval
                logit_upper_increase = ifelse(term=="(Intercept)",plogis(condval + 1.96 * condsd), "NA"),  # upper bound of confidence interval
                group_slopes_increase = ifelse(term=="reldist_leading_scaled", .$condval + fixed_slope_increase, "NA")) # species-specific slope


plot_species_slope_increase = ggplot(ranef_mod_increase, aes(x = as.factor(Group), y = as.numeric(group_slopes_increase), fill = factor(Group))) + 
  stat_halfeye(adjust = 0.9,
               justification = -.1,
               .width = 0.01,
               point_colour = NA) +
  geom_boxplot(alpha = 0.6,
               width = .1) +
  scale_fill_manual(values = cols1) + theme_classic(base_size = 17) + geom_hline(yintercept = 0, color = "black", size = .7, linetype = 2) +
  ylab("Slope of probability of increasing x Distance to leading edge") + 
  xlab("") +  theme(legend.position="none",
                    axis.text.x=element_text(size=15)) +
  coord_flip()

print(plot_species_slope_increase)
ggsave(plot = last_plot(),"slope_speciesgroup_decreasing_trailing.jpg")


```
<br> <br>

